#!/bin/bash

layout=""
capacity=""
capacity_num=""
timedate=""
status=""
brightness=""
volume=""
cpu_temp=""
dns=""
bluetooth=""

get_layout() {
kb=$(xset -q | grep -oP '\d{8}')

  case $kb in
    "00001000")
    layout="ru"
    ;;
    "00000000")
    layout="en"
    ;;
  esac
}

battery() {
    capacity_num="$(cat /sys/class/power_supply/BAT0/capacity)"
    capacity="${capacity_num}%"
    status="$(cat /sys/class/power_supply/BAT0/status)"
}

timedate() {
    timedate=$(date +"%A %d-%m-%Y %H:%M:%S")
}

brightness() {
    local bl=$(ls /sys/class/backlight/ | head -1)
    if [ -n "$bl" ]; then
        local cur=$(cat /sys/class/backlight/$bl/brightness)
        local max=$(cat /sys/class/backlight/$bl/max_brightness)
        brightness=$((cur * 100 / max))%
    else
        brightness="N/A"
    fi
}

volume() {
    volume=$(amixer sget Master | awk '/Front Left:/ {print $5 $6}')
}

cpu_temp() {
    for zone in /sys/class/thermal/thermal_zone*; do
        if grep -q "x86_pkg_temp\|coretemp\|k10temp" "$zone/type" 2>/dev/null; then
            cpu_temp=$(printf "%3dÂ°C" $(($(cat "$zone/temp") / 1000)))
            return
        fi
    done
    cpu_temp="N/A"
}

dns() {
    dns=$(nmcli dev show | awk '/IP4.DNS\[1\]/ {print $2}')
}

bluetooth() {
    bluetooth=$(bluetoothctl devices Connected | awk '{$1=$2=""; print substr($0,3)}' | paste -sd, -)
    [ -z "$bluetooth" ] && bluetooth="-"
}

# Output JSON header for i3bar protocol
echo '{"version":1}'
echo '['
echo '[]'

while :
do
  get_layout
  battery
  brightness
  timedate
  volume
  cpu_temp
  dns
  bluetooth

  # Battery status color
  if [ "$status" = "Charging" ]; then
      status_color=',"color":"#00FF00"'  # green
  elif [ "$status" = "Discharging" ]; then
      status_color=',"color":"#FFFF00"'  # yellow
  else
      status_color=""
  fi

  # Battery capacity color
  if [ "$capacity_num" -lt 10 ]; then
      capacity_color=',"color":"#FF0000"'  # red - critical
  elif [ "$capacity_num" -lt 20 ]; then
      capacity_color=',"color":"#FF6600"'  # orange - low
  elif [ "$capacity_num" -lt 40 ]; then
      capacity_color=',"color":"#FFFF00"'  # yellow - medium
  else
      capacity_color=""
  fi

  # CPU temp color
  cpu_temp_num=$(echo "$cpu_temp" | grep -oP '\d+')
  if [ "$cpu_temp_num" -gt 80 ] 2>/dev/null; then
      cpu_color=',"color":"#FF0000"'  # red - hot
  elif [ "$cpu_temp_num" -gt 65 ] 2>/dev/null; then
      cpu_color=',"color":"#FF6600"'  # orange - warm
  else
      cpu_color=""
  fi

  # Volume color (red if muted)
  if echo "$volume" | grep -q "\[off\]"; then
      volume_color=',"color":"#FF0000"'
  else
      volume_color=""
  fi

  # DNS color (red if stage)
  stage_dns="10.13.245.31"
  if [ "$dns" = "$stage_dns" ]; then
      dns_color=',"color":"#FF0000"'
      dns_suffix=" (stage)"
  else
      dns_color=""
      dns_suffix=""
  fi

  echo ",[
    {\"full_text\":\"$layout\",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\" | bt: \",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\"$bluetooth\",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\" | dns: \",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\"$dns$dns_suffix\"$dns_color,\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\" | cpu: \",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\"$cpu_temp\"$cpu_color,\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\" | volume: \",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\"$volume\"$volume_color,\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\" | brightness: \",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\"$brightness\",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\" | \",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\"$capacity\"$capacity_color,\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\" \",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\"$status\"$status_color,\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\" | \",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\"$timedate\"}
  ]"
  sleep 1
done
