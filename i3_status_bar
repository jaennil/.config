#!/bin/bash

layout=""
capacity=""
capacity_num=""
timedate=""
status=""
brightness=""
volume=""
cpu_temp=""
dns=""
bluetooth=""
low_battery_notified=""
wifi=""
vpn=""
cpu_usage=""
prev_idle=0
prev_total=0
ram_usage=""
top_process=""
top_ram_process=""

get_layout() {
kb=$(xset -q | grep -oP '\d{8}')

  case $kb in
    "00001000")
    layout="ru"
    ;;
    "00000000")
    layout="en"
    ;;
  esac
}

battery() {
    capacity_num="$(cat /sys/class/power_supply/BAT0/capacity)"
    capacity="${capacity_num}%"
    status="$(cat /sys/class/power_supply/BAT0/status)"
}

timedate() {
    timedate=$(date +"%A %d-%m-%Y %H:%M:%S")
}

brightness() {
    local bl=$(ls /sys/class/backlight/ | head -1)
    if [ -n "$bl" ]; then
        local cur=$(cat /sys/class/backlight/$bl/brightness)
        local max=$(cat /sys/class/backlight/$bl/max_brightness)
        brightness=$((cur * 100 / max))%
    else
        brightness="N/A"
    fi
}

volume() {
    volume=$(amixer sget Master | awk '/Front Left:/ {print $5 $6}')
}

cpu_temp() {
    local zone
    for z in /sys/class/thermal/thermal_zone*; do
        if grep -q "x86_pkg_temp\|coretemp\|k10temp" "$z/type" 2>/dev/null; then
            zone="$z"
            break
        fi
    done
    if [ -n "$zone" ]; then
        cpu_temp=$(printf "%3dÂ°C" $(($(cat "$zone/temp") / 1000)))
    else
        cpu_temp="N/A"
    fi
}

cpu_usage() {
    local cpu_line=$(head -1 /proc/stat)
    local user=$(echo "$cpu_line" | awk '{print $2}')
    local nice=$(echo "$cpu_line" | awk '{print $3}')
    local system=$(echo "$cpu_line" | awk '{print $4}')
    local idle=$(echo "$cpu_line" | awk '{print $5}')
    local iowait=$(echo "$cpu_line" | awk '{print $6}')
    local irq=$(echo "$cpu_line" | awk '{print $7}')
    local softirq=$(echo "$cpu_line" | awk '{print $8}')

    local total=$((user + nice + system + idle + iowait + irq + softirq))
    local diff_idle=$((idle - prev_idle))
    local diff_total=$((total - prev_total))

    if [ "$diff_total" -gt 0 ]; then
        cpu_usage=$((100 * (diff_total - diff_idle) / diff_total))%
    else
        cpu_usage="0%"
    fi

    prev_idle=$idle
    prev_total=$total
}

ram_usage() {
    local total=$(awk '/MemTotal/ {print $2}' /proc/meminfo)
    local available=$(awk '/MemAvailable/ {print $2}' /proc/meminfo)
    local used=$((total - available))
    ram_usage=$((used * 100 / total))%
}

top_process() {
    top_process=$(top -bn1 -o %CPU | awk 'NR>7 {
        name = substr($12, 1, 8)
        pad = int((8 - length(name)) / 2)
        printf "%*s%-*s %3.0f%%", pad, "", 8 - pad, name, $9
        exit
    }')
}

top_ram_process() {
    top_ram_process=$(top -bn1 -o %MEM | awk 'NR>7 {
        name = substr($12, 1, 8)
        pad = int((8 - length(name)) / 2)
        printf "%*s%-*s %3.0f%%", pad, "", 8 - pad, name, $10
        exit
    }')
}

dns() {
    dns=$(nmcli dev show | awk '/IP4.DNS/ {print $2}' | tr '\n' ' ' | sed 's/ $//' | sed 's/ /  /g')
}

wifi() {
    local ssid=$(iwgetid -r 2>/dev/null)
    if [ -n "$ssid" ]; then
        local quality=$(awk 'NR==3 {printf "%.0f%%", $3*100/70}' /proc/net/wireless 2>/dev/null)
        wifi="$ssid $quality"
    else
        wifi="down"
    fi
}

vpn() {
    if nmcli -t -f TYPE,STATE connection show --active 2>/dev/null | grep -q "^vpn:"; then
        vpn="up"
    else
        vpn="down"
    fi
}

bluetooth() {
    local devices=$(bluetoothctl devices Connected | awk '{print $2}')
    if [ -z "$devices" ]; then
        bluetooth="-"
        bluetooth_battery=""
        return
    fi

    local names=""
    local batteries=""
    for mac in $devices; do
        local name=$(bluetoothctl info "$mac" | awk -F': ' '/Name:/ {print $2}')
        names="${names}${name}, "

        local bat=$(upower -e 2>/dev/null | grep -i "${mac//:/_}" | xargs -I{} upower -i {} 2>/dev/null | awk '/percentage:/ {print $2}' | tr -d '%')
        [ -n "$bat" ] && batteries="${batteries}${bat}% " || batteries="${batteries}N/A "
    done

    bluetooth="${names%, }"
    bluetooth_battery="${batteries% }"
}

# Output JSON header for i3bar protocol
echo '{"version":1}'
echo '['
echo '[]'

while :
do
  get_layout
  battery
  brightness
  timedate
  volume
  cpu_temp
  cpu_usage
  ram_usage
  top_process
  top_ram_process
  dns
  bluetooth
  wifi
  vpn

  # Low battery notification
  if [ "$capacity_num" -le 20 ] && [ "$status" = "Discharging" ] && [ -z "$low_battery_notified" ]; then
      notify-send -u critical "Low Battery" "Battery at ${capacity_num}%"
      low_battery_notified="1"
  elif [ "$capacity_num" -gt 20 ] || [ "$status" = "Charging" ]; then
      low_battery_notified=""
  fi

  # Battery status color
  if [ "$status" = "Charging" ]; then
      status_color=',"color":"#00FF00"'  # green
  elif [ "$status" = "Discharging" ]; then
      status_color=',"color":"#FFFF00"'  # yellow
  else
      status_color=""
  fi

  # Battery capacity color
  if [ "$capacity_num" -lt 30 ]; then
      capacity_color=',"color":"#FF0000"'  # red
  elif [ "$capacity_num" -lt 60 ]; then
      capacity_color=',"color":"#FFFF00"'  # yellow
  else
      capacity_color=',"color":"#00FF00"'  # green
  fi

  # CPU temp color
  cpu_temp_num=$(echo "$cpu_temp" | grep -oP '\d+')
  if [ "$cpu_temp_num" -gt 95 ] 2>/dev/null; then
      cpu_color=',"color":"#FF0000"'  # red - hot
  elif [ "$cpu_temp_num" -gt 65 ] 2>/dev/null; then
      cpu_color=',"color":"#FF6600"'  # orange - warm
  else
      cpu_color=',"color":"#00FF00"'  # green - normal
  fi

  # Volume color
  if echo "$volume" | grep -q "\[off\]"; then
      volume_color=',"color":"#00FF00"'  # green - muted
  else
      volume_color=',"color":"#FF6600"'  # orange - on
  fi

  # DNS color (red if stage)
  stage_dns="10.13.245.31"
  if [ "$dns" = "$stage_dns" ]; then
      dns_color=',"color":"#FF0000"'
      dns_suffix=" (stage)"
  else
      dns_color=""
      dns_suffix=""
  fi

  # Bluetooth battery color
  bt_bat_num=$(echo "$bluetooth_battery" | grep -oP '^\d+' | head -1)
  if [ -n "$bt_bat_num" ]; then
      if [ "$bt_bat_num" -lt 10 ]; then
          bt_bat_color=',"color":"#FF0000"'  # red
      elif [ "$bt_bat_num" -lt 20 ]; then
          bt_bat_color=',"color":"#FF6600"'  # orange
      elif [ "$bt_bat_num" -lt 40 ]; then
          bt_bat_color=',"color":"#FFFF00"'  # yellow
      else
          bt_bat_color=',"color":"#00FF00"'  # green - good
      fi
  else
      bt_bat_color=""
  fi

  # VPN color
  if [ "$vpn" = "up" ]; then
      vpn_color=',"color":"#00FF00"'  # green
  else
      vpn_color=',"color":"#FF6600"'  # orange
  fi

  # Layout color
  if [ "$layout" = "en" ]; then
      layout_color=',"color":"#00FF00"'  # green
  else
      layout_color=',"color":"#FFFF00"'  # yellow
  fi

  # CPU usage color
  cpu_usage_num=$(echo "$cpu_usage" | grep -oP '\d+')
  if [ "$cpu_usage_num" -gt 90 ] 2>/dev/null; then
      cpu_usage_color=',"color":"#FF0000"'  # red - critical
  elif [ "$cpu_usage_num" -gt 70 ] 2>/dev/null; then
      cpu_usage_color=',"color":"#FF6600"'  # orange - high
  elif [ "$cpu_usage_num" -gt 50 ] 2>/dev/null; then
      cpu_usage_color=',"color":"#FFFF00"'  # yellow - medium
  else
      cpu_usage_color=',"color":"#00FF00"'  # green - normal
  fi

  # RAM usage color
  ram_usage_num=$(echo "$ram_usage" | grep -oP '\d+')
  if [ "$ram_usage_num" -gt 90 ] 2>/dev/null; then
      ram_usage_color=',"color":"#FF0000"'  # red - critical
  elif [ "$ram_usage_num" -gt 70 ] 2>/dev/null; then
      ram_usage_color=',"color":"#FF6600"'  # orange - high
  elif [ "$ram_usage_num" -gt 50 ] 2>/dev/null; then
      ram_usage_color=',"color":"#FFFF00"'  # yellow - medium
  else
      ram_usage_color=',"color":"#00FF00"'  # green - normal
  fi

  echo ",[
    {\"full_text\":\"cpu: \",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\"$cpu_temp\"$cpu_color,\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\" \",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\"$cpu_usage\"$cpu_usage_color,\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\" \",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\"$top_process\",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\" | ram: \",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\"$ram_usage\"$ram_usage_color,\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\" \",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\"$top_ram_process\",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\" | wifi: \",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\"$wifi\",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\" | vpn: \",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\"$vpn\"$vpn_color,\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\" | bt: \",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\"$bluetooth\",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\" \",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\"$bluetooth_battery\"$bt_bat_color,\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\" | dns: \",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\"$dns$dns_suffix\"$dns_color,\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\" | volume: \",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\"$volume\"$volume_color,\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\" | brightness: \",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\"$brightness\",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\" | \",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\"$capacity\"$capacity_color,\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\" \",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\"$status\"$status_color,\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\" | \",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\"$layout\"$layout_color,\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\" | \",\"separator\":false,\"separator_block_width\":0},
    {\"full_text\":\"$timedate\"}
  ]"
  sleep 0.2
done
