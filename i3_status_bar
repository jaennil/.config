#!/bin/bash

layout=""
capacity=""
timedate=""
status=""
brightness=""
volume=""
cpu_temp=""
dns=""
bluetooth=""

get_layout() {
kb=$(xset -q | grep -oP '\d{8}')

  case $kb in
    "00001000")
    layout="ru"
    ;;
    "00000000")
    layout="en"
    ;;
  esac
}

battery() {
    capacity="$(cat /sys/class/power_supply/BAT0/capacity)%"
    status="$(cat /sys/class/power_supply/BAT0/status)"
}

timedate() {
    timedate=$(date +"%A %d-%m-%Y %H:%M:%S")
}

brightness() {
    local bl=$(ls /sys/class/backlight/ | head -1)
    if [ -n "$bl" ]; then
        local cur=$(cat /sys/class/backlight/$bl/brightness)
        local max=$(cat /sys/class/backlight/$bl/max_brightness)
        brightness=$((cur * 100 / max))%
    else
        brightness="N/A"
    fi
}

volume() {
    volume=$(amixer sget Master | awk '/Front Left:/ {print $5 $6}')
}

cpu_temp() {
    for zone in /sys/class/thermal/thermal_zone*; do
        if grep -q "x86_pkg_temp\|coretemp\|k10temp" "$zone/type" 2>/dev/null; then
            cpu_temp=$(($(cat "$zone/temp") / 1000))Â°C
            return
        fi
    done
    cpu_temp="N/A"
}

dns() {
    dns=$(nmcli dev show | awk '/IP4.DNS\[1\]/ {print $2}')
}

bluetooth() {
    bluetooth=$(bluetoothctl devices Connected | awk '{$1=$2=""; print substr($0,3)}' | paste -sd, -)
}

i3status | while :
do
  read line
  get_layout
  battery
  brightness
  timedate
  volume
  cpu_temp
  dns
  bluetooth
  echo "$layout | bt: $bluetooth | dns: $dns | cpu: $cpu_temp | volume: $volume | brightness: $brightness | $capacity $status | $timedate | $line" || exit 1
done
