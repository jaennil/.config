#!/bin/bash

layout=""
capacity=""
capacity_num=""
timedate=""
status=""
brightness=""
volume=""
cpu_temp=""
dns=""
bluetooth=""

get_layout() {
kb=$(xset -q | grep -oP '\d{8}')

  case $kb in
    "00001000")
    layout="ru"
    ;;
    "00000000")
    layout="en"
    ;;
  esac
}

battery() {
    capacity_num="$(cat /sys/class/power_supply/BAT0/capacity)"
    capacity="${capacity_num}%"
    status="$(cat /sys/class/power_supply/BAT0/status)"
}

timedate() {
    timedate=$(date +"%A %d-%m-%Y %H:%M:%S")
}

brightness() {
    local bl=$(ls /sys/class/backlight/ | head -1)
    if [ -n "$bl" ]; then
        local cur=$(cat /sys/class/backlight/$bl/brightness)
        local max=$(cat /sys/class/backlight/$bl/max_brightness)
        brightness=$((cur * 100 / max))%
    else
        brightness="N/A"
    fi
}

volume() {
    volume=$(amixer sget Master | awk '/Front Left:/ {print $5 $6}')
}

cpu_temp() {
    for zone in /sys/class/thermal/thermal_zone*; do
        if grep -q "x86_pkg_temp\|coretemp\|k10temp" "$zone/type" 2>/dev/null; then
            cpu_temp=$(printf "%3dÂ°C" $(($(cat "$zone/temp") / 1000)))
            return
        fi
    done
    cpu_temp="N/A"
}

dns() {
    dns=$(nmcli dev show | awk '/IP4.DNS\[1\]/ {print $2}')
}

bluetooth() {
    bluetooth=$(bluetoothctl devices Connected | awk '{$1=$2=""; print substr($0,3)}' | paste -sd, -)
}

# Output JSON header for i3bar protocol
echo '{"version":1}'
echo '['
echo '[]'

while :
do
  get_layout
  battery
  brightness
  timedate
  volume
  cpu_temp
  dns
  bluetooth

  # Battery color
  if [ "$status" = "Charging" ]; then
      battery_color=',"color":"#00FF00"'  # green when charging
  elif [ "$capacity_num" -lt 10 ]; then
      battery_color=',"color":"#FF0000"'  # red - critical
  elif [ "$capacity_num" -lt 20 ]; then
      battery_color=',"color":"#FF6600"'  # orange - low
  elif [ "$capacity_num" -lt 40 ]; then
      battery_color=',"color":"#FFFF00"'  # yellow - medium
  else
      battery_color=""
  fi

  # CPU temp color
  cpu_temp_num=$(echo "$cpu_temp" | grep -oP '\d+')
  if [ "$cpu_temp_num" -gt 80 ] 2>/dev/null; then
      cpu_color=',"color":"#FF0000"'  # red - hot
  elif [ "$cpu_temp_num" -gt 65 ] 2>/dev/null; then
      cpu_color=',"color":"#FF6600"'  # orange - warm
  else
      cpu_color=""
  fi

  # Volume color (red if muted)
  if echo "$volume" | grep -q "\[off\]"; then
      volume_color=',"color":"#FF0000"'
  else
      volume_color=""
  fi

  echo ",[
    {\"full_text\":\"$layout\"},
    {\"full_text\":\"bt: $bluetooth\"},
    {\"full_text\":\"dns: $dns\"},
    {\"full_text\":\"cpu: $cpu_temp\"$cpu_color},
    {\"full_text\":\"volume: $volume\"$volume_color},
    {\"full_text\":\"brightness: $brightness\"},
    {\"full_text\":\"$capacity $status\"$battery_color},
    {\"full_text\":\"$timedate\"}
  ]"
  sleep 1
done
